<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Web OS – Connexion Google + Explorateur (Responsive)</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root{
      --glass: rgba(255,255,255,0.12);
      --glass-strong: rgba(255,255,255,0.18);
      --border: rgba(255,255,255,0.25);
      --primary: #1a73e8;
      --danger: #d93025;
      --ok: #188038;
      --text: #fff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      font-family: 'Google Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    /* Clock */
    .clock { position: fixed; top: 16px; left: 16px; background: rgba(0,0,0,0.45); padding: 6px 12px; border-radius: 10px; font-size: 14px; letter-spacing: .5px; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }

    /* Logout button (only when connected) */
    #logout-btn { position: fixed; top: 16px; right: 16px; padding: 10px 14px; background: var(--danger); border: none; border-radius: 10px; cursor: pointer; color: #fff; transition: filter .2s; display: none; z-index: 1000; box-shadow: 0 4px 16px rgba(0,0,0,.25); }
    #logout-btn:hover { filter: brightness(0.95) }

    /* Dock (hidden until connected) */
    .dock { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 20px; padding: 10px 12px; display: none; align-items: center; gap: 14px; box-shadow: 0 10px 28px rgba(0,0,0,.35); max-width: min(100vw - 24px, 1100px); overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
    .dock::-webkit-scrollbar{ height: 0px; }
    .dock a, .dock button.icon { min-width: clamp(40px, 6vw, 56px); min-height: clamp(40px, 6vw, 56px); width: clamp(40px, 6vw, 56px); height: clamp(40px, 6vw, 56px); display: flex; align-items: center; justify-content: center; border-radius: 14px; transition: transform .18s, background .25s; background: transparent; border: none; cursor: pointer; flex: 0 0 auto; }
    .dock a:hover, .dock button.icon:hover { transform: scale(1.08); background: var(--glass-strong); }
    .dock img { width: 100%; height: 100%; object-fit: contain; }
    .dock form { display: flex; align-items: center; background: var(--glass-strong); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; flex: 0 0 auto; }
    .dock input[type="text"] { border: none; padding: 10px 12px; font-size: clamp(12px, 2.8vw, 14px); outline: none; background: transparent; color: white; width: clamp(140px, 26vw, 220px); }
    .dock button.search { background: transparent; border: none; cursor: pointer; padding: 8px; display:flex; align-items:center; }
    .dock button.search img { width: clamp(18px, 3.2vw, 22px); height: clamp(18px, 3.2vw, 22px); }

    /* Sign-in placeholder title */
    h1#title{ text-shadow: 0 6px 22px rgba(0,0,0,.45); margin: 0 12px 80px; text-align:center }

    /* ---------- Explorer (Material-like) ---------- */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; z-index: 1200; padding: 0; }
    .sheet { width: min(100vw - 40px, 980px); height: min(90vh, 640px); background: rgba(30,30,30,.94); backdrop-filter: blur(14px); border: 1px solid var(--border); border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,.55); }
    .sheet header { display: flex; gap: 10px; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.06); flex-wrap: wrap; }
    .title { display: flex; align-items: center; gap: 10px; font-weight: 500; }
    .chips { display: flex; gap: 8px; }
    .chip { background: rgba(255,255,255,.08); border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 12px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding: 10px 14px; border-radius: 10px; border:1px solid var(--border); background: rgba(255,255,255,.08); color:#fff; cursor:pointer; transition: background .2s, border-color .2s; touch-action: manipulation; }
    .btn:hover{ background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.45); }
    .btn.primary{ background: var(--primary); border-color: var(--primary); }
    .btn.primary:hover{ filter: brightness(0.95); }
    .btn.danger{ background: var(--danger); border-color: var(--danger); }

    .crumbs { display:flex; gap:8px; align-items:center; padding: 10px 14px; border-bottom:1px solid var(--border); white-space:nowrap; overflow:auto; }
    .crumb { background: rgba(255,255,255,.08); border:1px solid var(--border); padding:8px 12px; border-radius: 10px; cursor:pointer; flex:0 0 auto; }

    .body { display: grid; grid-template-columns: 260px 1fr; gap: 0; flex: 1; min-height: 0; }
    .sidebar { border-right:1px solid var(--border); padding: 10px; display:flex; flex-direction:column; gap:10px; }
    .list { overflow:auto; padding: 8px; }
    .row { display:grid; grid-template-columns: 36px 1fr 200px 1fr; align-items:center; gap:12px; padding:10px; border-radius:12px; border:1px solid transparent; min-height: 44px; }
    .row:hover { background: rgba(255,255,255,.06); border-color: var(--border); }
    .icon { width: 26px; height: 26px; opacity:.95 }
    .name { font-weight:500 }
    .muted { color: #cfd8dc99; font-size: 12px; }

    .editor { border-top:1px solid var(--border); display:none; flex-direction:column; }
    .editor textarea { width:100%; height:200px; padding:14px; border:none; outline:none; color:#fff; background:#1e1e1e; font: 13px/1.5 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; border-radius: 0; }
    .editor .actions { display:flex; justify-content:flex-end; gap:8px; padding: 10px; border-top:1px solid var(--border); }

    /* ======= Responsive Tweaks ======= */
    @media (max-width: 1024px){ /* Tablette */
      .body{ grid-template-columns: 220px 1fr; }
      .row{ grid-template-columns: 32px 1fr 160px 1fr; }
      .dock{ gap: 12px; }
      #logout-btn{ padding: 10px 12px; }
    }
    @media (max-width: 680px){ /* Smartphone */
      .clock{ top: env(safe-area-inset-top, 12px); left: 12px; font-size: 12px; padding: 6px 10px; }
      #logout-btn{ top: env(safe-area-inset-top, 12px); right: 12px; padding: 10px 12px; border-radius: 12px; }
      h1#title{ font-size: 1.25rem; margin-bottom: 64px; }

      .dock{ left: 50%; bottom: 10px; border-radius: 16px; gap: 10px; padding: 10px 10px; max-width: calc(100vw - 12px); }
      .dock input[type="text"]{ width: clamp(110px, 40vw, 160px); }

      .sheet{ width: 100vw; height: 100vh; border-radius: 0; }
      .sheet header{ gap: 8px; padding: 10px; }
      .body{ display: block; }
      .sidebar{ display:flex; flex-direction: row; gap: 8px; padding: 10px; border-right: none; border-bottom: 1px solid var(--border); overflow-x: auto; }
      .list{ padding: 10px; }
      .row{ grid-template-columns: 32px 1fr auto; gap: 10px; }
      .muted{ display:none; }
      .editor textarea{ height: 45vh; }
    }
  </style>
</head>
<body>
  <div class="clock" id="clock"></div>

  <h1 id="title">Web OS – Connexion avec Google</h1>

  <!-- Google Identity Services -->
  <div id="g_id_onload"
       data-client_id="908397631579-20c8p66k2ag6rkqhkc8u5r4nqaihndou.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin"
       data-type="standard" data-size="large" data-theme="outline"
       data-text="signin_with" data-shape="rectangular" data-logo_alignment="left">
  </div>

  <button id="logout-btn" onclick="logout()">Se déconnecter</button>

  <!-- Dock (après connexion) | liens externes avec icônes officielles -->
  <div class="dock" id="dock">
    <button class="icon" title="Explorateur de fichiers" onclick="openExplorer()" aria-label="Ouvrir l'explorateur">
      <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M10 4H4a2 2 0 0 0-2 2v2h20V8a2 2 0 0 0-2-2h-8l-2-2z" opacity=".8"/><path d="M22 10H2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-8z"/></svg>
    </button>
    <a href="https://mail.google.com" target="_blank" title="Gmail" aria-label="Gmail"><img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" alt="Gmail"></a>
    <a href="https://drive.google.com" target="_blank" title="Google Drive" aria-label="Google Drive"><img src="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png" alt="Drive"></a>
    <a href="https://docs.google.com/document" target="_blank" title="Google Docs" aria-label="Google Docs"><img src="https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico" alt="Docs"></a>
    <a href="https://docs.google.com/spreadsheets" target="_blank" title="Google Sheets" aria-label="Google Sheets"><img src="https://ssl.gstatic.com/docs/spreadsheets/favicon3.ico" alt="Sheets"></a>
    <a href="https://calendar.google.com" target="_blank" title="Google Agenda" aria-label="Google Agenda"><img src="https://ssl.gstatic.com/calendar/images/dynamiclogo_2020q4/calendar_48dp.png" alt="Agenda"></a>
    <a href="https://www.youtube.com" target="_blank" title="YouTube" aria-label="YouTube"><img src="https://www.youtube.com/s/desktop/fbffb14c/img/favicon_48.png" alt="YouTube"></a>
    <form action="https://www.google.com/search" method="GET" target="_blank" aria-label="Recherche Google">
      <input type="text" name="q" placeholder="Rechercher..." aria-label="Rechercher sur Google">
      <button type="submit" class="search" aria-label="Lancer la recherche"><img src="https://www.google.com/favicon.ico" alt="Search"></button>
    </form>
  </div>

  <!-- Modal Explorateur -->
  <div class="modal" id="explorer-modal" role="dialog" aria-modal="true" aria-labelledby="explorer-title">
    <div class="sheet">
      <header>
        <div class="title">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M10 4H4a2 2 0 0 0-2 2v2h20V8a2 2 0 0 0-2-2h-8l-2-2z" opacity=".8"/><path d="M22 10H2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-8z"/></svg>
          <span id="explorer-title">Explorateur de fichiers</span>
          <div class="chips"><span class="chip" id="support-chip">FS Access API</span></div>
        </div>
        <div class="toolbar">
          <button class="btn" onclick="chooseFolder()">📂 Ouvrir un dossier</button>
          <button class="btn" onclick="createFolder()">📁 Nouveau dossier</button>
          <button class="btn" onclick="createFile()">📄 Nouveau fichier</button>
          <button class="btn danger" onclick="closeExplorer()">Fermer</button>
        </div>
      </header>

      <div class="crumbs" id="breadcrumbs"></div>

      <div class="body">
        <aside class="sidebar">
          <button class="btn" onclick="goUp()">⬆️ Remonter</button>
          <button class="btn" onclick="refreshList()">🔄 Actualiser</button>
          <div class="muted" id="folder-info"></div>
        </aside>
        <section class="list" id="file-list" aria-live="polite"></section>
      </div>

      <div class="editor" id="editor">
        <textarea id="editor-text" placeholder="Éditez le contenu ici..."></textarea>
        <div class="actions">
          <button class="btn" onclick="closeEditor()">Annuler</button>
          <button class="btn primary" onclick="saveEditor()">💾 Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------------------- Auth / UI state --------------------
    function handleCredentialResponse(response) {
      // Masquer l'UI de connexion et afficher dock + logout
      document.getElementById('title').style.display = 'none';
      document.querySelector('.g_id_signin').style.display = 'none';
      document.getElementById('logout-btn').style.display = 'block';
      document.getElementById('dock').style.display = 'flex';
    }
    function logout() {
      google.accounts.id.disableAutoSelect();
      document.getElementById('title').style.display = 'block';
      document.querySelector('.g_id_signin').style.display = 'block';
      document.getElementById('logout-btn').style.display = 'none';
      document.getElementById('dock').style.display = 'none';
      closeExplorer();
    }
    function updateClock(){ const now=new Date(); document.getElementById('clock').textContent = now.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});} setInterval(updateClock,1000); updateClock();

    // -------------------- File System Access API Explorer --------------------
    let currentDir = null;           // FileSystemDirectoryHandle
    let parentStack = [];            // breadcrumb stack
    let openFileHandle = null;       // currently opened file for editor

    // Capability check
    const supported = ('showDirectoryPicker' in window);
    document.getElementById('support-chip').textContent = supported ? 'FS Access API : OK' : 'FS Access API : Non supporté';

    function openExplorer(){
      document.getElementById('explorer-modal').style.display = 'flex';
      if(!supported){
        alert("Votre navigateur ne supporte pas la File System Access API. Utilisez Chrome/Edge/Opera.");
        return;
      }
      if(!currentDir){ chooseFolder(); } else { refreshList(); }
    }
    function closeExplorer(){ document.getElementById('explorer-modal').style.display = 'none'; }

    async function chooseFolder(){
      try{
        currentDir = await window.showDirectoryPicker({ id: 'webos-root', mode: 'readwrite' });
        parentStack = [ { name: await dirName(currentDir), handle: currentDir } ];
        await refreshList();
      }catch(err){ if(err && err.name!=='AbortError') console.error(err); }
    }

    async function dirName(dirHandle){ return dirHandle.name || 'Dossier'; }

    function crumbsRender(){
      const wrap = document.getElementById('breadcrumbs');
      wrap.innerHTML = '';
      parentStack.forEach((node, idx)=>{
        const span = document.createElement('span');
        span.className = 'crumb';
        span.textContent = node.name;
        span.onclick = async ()=>{
          parentStack = parentStack.slice(0, idx+1);
          currentDir = parentStack[parentStack.length-1].handle;
          await refreshList();
        };
        wrap.appendChild(span);
      });
    }

    async function goUp(){
      if(!currentDir || parentStack.length<=1) return; // can't go above root chosen
      parentStack.pop();
      currentDir = parentStack[parentStack.length-1].handle;
      await refreshList();
    }

    async function refreshList(){
      if(!currentDir) return;
      crumbsRender();
      const list = document.getElementById('file-list');
      list.innerHTML = '';
      let countFiles=0, countDirs=0;
      for await (const [name, entry] of currentDir.entries()){
        const row = document.createElement('div');
        row.className = 'row';
        const icon = document.createElement('div'); icon.className='icon'; icon.innerHTML = entry.kind==='directory' ? folderSVG() : fileSVG();
        const nameEl = document.createElement('div'); nameEl.className = 'name'; nameEl.textContent = name;
        const kind = document.createElement('div'); kind.className='muted'; kind.textContent = entry.kind;
        const actions = document.createElement('div');
        const btnOpen = document.createElement('button'); btnOpen.className='btn'; btnOpen.textContent = entry.kind==='directory' ? 'Ouvrir' : 'Lire';
        btnOpen.onclick = ()=> entry.kind==='directory' ? openFolder(entry, name) : openFile(entry);
        const btnDelete = document.createElement('button'); btnDelete.className='btn danger'; btnDelete.textContent='Supprimer'; btnDelete.onclick = ()=> removeEntry(name);
        actions.append(btnOpen, btnDelete);
        if(entry.kind==='file'){
          const btnRename = document.createElement('button'); btnRename.className='btn'; btnRename.textContent='Renommer'; btnRename.onclick = ()=> renameFile(entry, name);
          actions.append(btnRename);
        }
        row.append(icon, nameEl, kind, actions);
        list.appendChild(row);
        if(entry.kind==='directory') countDirs++; else countFiles++;
      }
      document.getElementById('folder-info').textContent = `${countDirs} dossier(s), ${countFiles} fichier(s)`;
    }

    async function openFolder(dirHandle, dirName){
      parentStack.push({ name: dirName, handle: dirHandle });
      currentDir = dirHandle;
      await refreshList();
    }

    function folderSVG(){ return '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4a2 2 0 0 0-2 2v2h20V8a2 2 0 0 0-2-2h-8l-2-2z" opacity=".8"/><path d="M22 10H2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-8z"/></svg>'; }
    function fileSVG(){ return '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6" opacity=".7"/></svg>'; }

    // ---- CRUD ----
    async function createFolder(){
      if(!currentDir) return alert('Ouvrez d\'abord un dossier');
      const name = prompt('Nom du dossier :');
      if(!name) return;
      await currentDir.getDirectoryHandle(name, { create: true });
      await refreshList();
    }
    async function createFile(){
      if(!currentDir) return alert('Ouvrez d\'abord un dossier');
      const name = prompt('Nom du fichier (ex: note.txt) :');
      if(!name) return;
      const fh = await currentDir.getFileHandle(name, { create: true });
      const w = await fh.createWritable(); await w.write(''); await w.close();
      await refreshList();
    }
    async function removeEntry(name){
      if(!currentDir) return;
      if(!confirm(`Supprimer \"${name}\" ?`)) return;
      try{ await currentDir.removeEntry(name, { recursive: true }); } catch(e){ alert('Suppression refusée ou impossible'); }
      await refreshList();
    }

    // ---- Open / Edit text files ----
    function isTextLike(filename){ return /(\.(txt|md|csv|json|js|css|html|log)|^README$)/i.test(filename); }

    async function openFile(fileHandle){
      openFileHandle = fileHandle;
      const file = await fileHandle.getFile();
      const name = file.name || 'Fichier';
      if(!isTextLike(name)){
        const url = URL.createObjectURL(file);
        window.open(url, '_blank');
        return;
      }
      const text = await file.text();
      document.getElementById('editor-text').value = text;
      document.getElementById('editor').style.display = 'flex';
    }
    async function saveEditor(){
      if(!openFileHandle) return;
      const w = await openFileHandle.createWritable();
      await w.write(document.getElementById('editor-text').value);
      await w.close();
      closeEditor();
      await refreshList();
    }
    function closeEditor(){ document.getElementById('editor').style.display = 'none'; openFileHandle = null; }

    // ---- Rename file (copy new name + delete old) ----
    async function renameFile(fileHandle, oldName){
      try{
        const newName = prompt('Nouveau nom de fichier :', oldName);
        if(!newName || newName === oldName) return;
        const file = await fileHandle.getFile();
        const data = await file.arrayBuffer();
        const newFH = await currentDir.getFileHandle(newName, { create: true });
        const w = await newFH.createWritable(); await w.write(data); await w.close();
        await currentDir.removeEntry(oldName);
        await refreshList();
      }catch(e){ alert('Renommage non supporté ou refusé'); }
    }
  </script>
</body>
</html>
